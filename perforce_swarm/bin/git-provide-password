#!/usr/bin/env ruby

require_relative '../init'
require_relative '../config'
require_relative '../git_fusion'

begin
  # we expect the message "Password for 'url'..." to be passed as the first argument
  fail "We weren't asked to provide a password." if !ARGV || ARGV.empty?

  host     = ARGV[0][/^Password for '([^']+)'/, 1]
  fail "Unrecognized argument, expected \"Password for '...\"" unless host
  host     = PerforceSwarm::GitFusion::URL.new(host).to_s

  password = ''
  # find the matching config entry based on matching url, if we can
  PerforceSwarm::GitlabConfig.new.git_fusion_entries.each do |_id, entry|
    url = PerforceSwarm::GitFusion::URL.new(entry['url'])
    next unless url.to_s == host

    # return the explicitly configured password if present, fallback to the password specified in the URL
    # if neither is present, this results in empty string
    password = entry['password'] || url.password
  end
  puts password
rescue StandardError => e
  $logger.error "Failed to provide a password: #{e.message}"
  puts ''
end
